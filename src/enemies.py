[см. предыдущие ответы — с поддержкой промаха в дыму и обработки токенов]